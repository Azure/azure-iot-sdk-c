<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Azure IoT C SDK: Run End to End Tests</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Azure IoT C SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Run End to End Tests </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes how to run the end to end tests.</p>
<ul>
<li><a href="#testparams">Set up the test parameters</a></li>
<li><a href="#windows_client">Run end to end tests on a Windows development environment</a></li>
<li><a href="#linux_client">Run end to end tests for "iothub_client" on a Linux development environment</a></li>
</ul>
<p><a class="anchor" id="testparams"></a> </p>
<h1><a class="anchor" id="autotoc_md139"></a>
Setup the test parameters</h1>
<ul>
<li>Open the file "iot_device_params.txt" located under the tools\iot_hub_e2e_tests_params folders in your local copy of the repository.</li>
<li><p class="startli">Populate the information required in this file by extracting it from the Azure portal.</p><ul>
<li>Open the Azure IoT Hub you created in the Azure portal and navigate through "Shared Access Policies", and "iothubowner"</li>
<li><p class="startli">Locate one of the IoT Hub connection strings as shown in the figure below</p>
<p class="startli"><img src="media/azure_portal/azure-portal-iothub-constring.png" alt="" class="inline"/></p>
</li>
<li>The connection string will be in the following form: HostName=&lt;IOTHUB_NAME&gt;.&lt;IOTHUB_SUFFIX&gt;;SharedAccessKeyName=&lt;IOTHUB_POLICY_NAME&gt;;SharedAccessKey=&lt;IOTHUB_POLICY_KEY&gt;</li>
<li>Populate the following variables in the "iot_device_params.txt" file by matching the place holders with the ones from the IoT Hub connection string shown above.<ul>
<li>IOTHUB_CONNECTION_STRING=[entire connection string from azure portal]</li>
</ul>
</li>
<li>Locate the Event Hub settings as shown in the figure below</li>
</ul>
<p class="startli"><img src="media/azure_portal/azure-portal-eventhub-constring.png" alt="" class="inline"/></p><ul>
<li><p class="startli">Populate the following variables as described below.</p><ul>
<li>IOTHUB_EVENTHUB_CONNECTION_STRING=Endpoint=[Event Hub-compatible endpoint];SharedAccessKeyName=[IOTHUB_POLICY_NAME];SharedAccessKey=[IOTHUB_POLICY_KEY]</li>
<li>IOTHUB_EVENTHUB_CONSUMER_GROUP=$Default</li>
<li>IOTHUB_PARTITION_COUNT=[Partition count from portal]</li>
</ul>
<p class="startli">Note: IOTHUB_EVENTHUB_CONSUMER_GROUP is optional. If not provided, the assumed value is "$Default".</p>
</li>
<li><p class="startli">Set the x509 certificate information</p>
<p class="startli">The following parameters must also be provided in the configuration file:</p><ul>
<li>IOTHUB_E2E_X509_CERT_BASE64</li>
<li>IOTHUB_E2E_X509_PRIVATE_KEY_BASE64</li>
<li>IOTHUB_E2E_X509_THUMBPRINT</li>
</ul>
<p class="startli">For testing-only, you can generate a x509 self-signed certificate by either:</p>
<p class="startli">Using our script to fill these three parameters automatically with a <b>test-only</b> certificate:</p>
<p class="startli">```shell .../azure-iot-sdk-c/tools/iot_hub_e2e_tests_params$ ./fill_x509_in_iot_device_params.sh ```</p>
<p class="startli">OR following the manual steps below:</p>
<p class="startli">Generate the test-only self-signed using the following openssl command:</p>
<p class="startli">```Shell openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -nodes -days 365 -subj "/C=US/ST=Washington/L=Redmond/O=Company/OU=Org/CN=www.company.com" ```</p>
<p class="startli">Note: this command generates a pass-phrase-free certificate. Protect the file!</p>
<p class="startli">This will generate two files, one with the certificate information (<code>cert.pem</code>) and the other with the certificate key (<code>key.pem</code>).</p>
<p class="startli">Generate Base64-encoded strings out of each file (<code>cert.pem</code> and <code>key.pem</code>) and populate IOTHUB_E2E_X509_CERT_BASE64 and IOTHUB_E2E_X509_PRIVATE_KEY_BASE64 respectively.</p>
<p class="startli">Notes:</p><ul>
<li>There are several tools that can generate Base64-encoded strings. For example: Notepad++ with MIME Tools plugin.</li>
<li>If using the parameters on Linux, make sure newlines follow the proper style (<code>\n</code>) before doing the base64-encoding.</li>
</ul>
<p class="startli">The final piece of information (IOTHUB_E2E_X509_THUMBPRINT) can be obtained using the following command:</p>
<p class="startli">```Shell openssl x509 -noout -fingerprint -inform pem -in cert.pem ```</p>
<p class="startli">Note: IOTHUB_E2E_X509_THUMBPRINT takes a string with HEX characters only; make sure all colons or spaces are removed from the thumbprint.</p>
</li>
<li><p class="startli">Set the x509 certificate information for DPS:</p><ul>
<li>IOT_DPS_INDIVIDUAL_X509_CERTIFICATE</li>
<li>IOT_DPS_INDIVIDUAL_X509_KEY</li>
<li>IOT_DPS_INDIVIDUAL_REGISTRATION_ID</li>
</ul>
<p class="startli">The certificate must have CN = &lt;registration_id&gt; and EKU set to the Client Authentication OID.</p>
</li>
</ul>
</li>
</ul>
<p><a class="anchor" id="windows_client"></a> </p>
<h1><a class="anchor" id="autotoc_md140"></a>
Run end to end tests on a Windows development environment</h1>
<ul>
<li>Start the Windows PowerShell in Administrator mode. Update execution policy by entering "set-executionpolicy unrestricted"</li>
<li>Navigate to the folder tools\iot_hub_e2e_tests_params in your local copy of the repository.</li>
<li>Run the script "Set-IOTDeviceParametersForE2ETests.ps1" located under the tools\iot_hub_e2e_tests_params folders in your local copy of the repository.</li>
<li>Navigate to azure-iot-sdk-c\cmake <br  />
</li>
<li>From cmake directory, run cmake with option to enable e2e testing: Cmake -Drun_e2e_tests=ON ..</li>
<li>The test directory will be located here: azure-iot-sdk-c\cmake\iothub_client\tests</li>
<li>Start the Visual Studio solution "azure_iot_sdks.sln" located under the folder cmake in your home directory.</li>
<li>Build the solution</li>
<li>Run the tests by Test -&gt; Run -&gt; All Tests menu item inside of Visual Studio.</li>
</ul>
<p><a class="anchor" id="linux_client"></a> </p>
<h1><a class="anchor" id="autotoc_md141"></a>
Run end to end tests for "iothub_client" on a Linux development environment</h1>
<ul>
<li>Navigate to the folder tools/iot_hub_e2e_tests_params</li>
<li><p class="startli">Set the parameters in "iot_device_params.txt" as environment variables in the current session:</p>
<p class="startli">Notes:</p><ul>
<li>Make sure the contents of "iot_device_params.txt" are properly escaped for Linux (use "\$" for the '$' character).</li>
<li>Avoid using <code>/etc/environment</code> for defining these variables since it has string-size limitations (the certificate-related variables are too large).</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">set -a</div>
<div class="line">source ./iot_device_params.txt</div>
</div><!-- fragment --><ul>
<li>Navigate to azure-iot-sdk-c\cmake</li>
<li>From cmake directory run cmake with option to enable e2e testing: <code>cmake -Drun_e2e_tests=ON ..</code></li>
<li>The test directory will be located here: azure-iot-sdk-c\cmake\iothub_client\tests</li>
<li>In the azure-iot-sdk-c\cmake folder, run the following to run all tests: <code>ctest -C "Debug"</code> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.0
</small></address>
</body>
</html>
