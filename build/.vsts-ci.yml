name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true
phases:
- phase: iotz
  queue:
    name: devicelab-01
  steps:
  - script: |
      sudo apt-get update && apt-get install -y \
      curl \
      git \
      python-software-properties \
      build-essential \
      pkg-config
      sudo curl -sL https://deb.nodesource.com/setup_6.x | bash -
      sudo apt-get install -y nodejs
    displayName: 'setup'
  - script: |
      npm install iotz
      sudo ./../../node_modules/.bin/iotz update
      sudo rm -R -f mxchip
      git clone https://github.com/obastemur/mxchip_az3166_firmware.git mxchip
      rsync -avz --update --existing ./ mxchip/mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/
      cp -r provisioning_client/inc/azure_prov_client/internal mxchip/mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/inc/azure_prov_client/
	    git checkout -- Reference/DICE/DiceSha256.c
	    git checkout -- Reference/RIoT/Core/RIoTCrypt/RiotDerEnc.c
	    git checkout -- Reference/RIoT/Core/RIoTCrypt/RiotEcc.c
	    git checkout -- Reference/RIoT/Core/RIoTCrypt/RiotSha256.c
	  	git checkout -- mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/provisioning_client/adapters/hsm_client_riot.c
	    cp c-utility/src/base64.c mxchip/mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/c-utility/src/base64_utility.c
	    cp c-utility/src/base32.c mxchip/mbed-iot-devkit-sdk/cores/arduino/azure-iot-sdk-c/c-utility/src/base32_utility.c
      cd mxchip
      sudo ./../../../node_modules/.bin/iotz init mbed
      sudo ./../../../node_modules/.bin/iotz compile
    displayName: 'build'
  - script: |
      ls
      cp ./mxchip/BUILD/AZ3166/GCC_ARM/mxchip.bin /media/john/AZ3166
    displayName: 'deploy'
