name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true
phases:
- phase: iotz
  queue:
    name: Hosted Ubuntu 1604
  steps:
  - script: |
      sudo apt-get update && apt-get install -y \
      curl \
      git \
      python-software-properties \
      build-essential \
      pkg-config
      sudo curl -sL https://deb.nodesource.com/setup_6.x | bash -
      sudo apt-get install -y nodejs
    displayName: 'setup'
  - script: |
      npm install iotz
      ./../../node_modules/.bin/iotz update
      git clone https://github.com/obastemur/mxchip_az3166_firmware.git mxchip
      cd mxchip
      ./../../../node_modules/.bin/iotz init mbed
      ./../../../node_modules/.bin/iotz compile
    displayName: 'build'
- phase: raspberrypi
  variables:
    _PREVIEW_VSTS_DOCKER_IMAGE: "aziotbld/raspberrypi-c"
  queue: Hosted Ubuntu 1604
  displayName: raspberrypi
  steps:
  - script: |
     $HOME
     whoami
     ls -lr
     pwd
     sudo ./jenkins/raspberrypi_c.sh
    displayName: 'build'
  - script: sudo rm -rf $(Agent.BuildDirectory)/*
    displayName: 'cleanup'

