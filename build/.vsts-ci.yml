name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true
phases:
- phase: checksubmodule  
  queue:
    name: Hosted Ubuntu 1604
  steps:
  - script: |
      sudo apt-get update && apt-get install -y \
      curl \
      git \
      python-software-properties \
      build-essential \
      pkg-config
      sudo curl -sL https://deb.nodesource.com/setup_6.x | bash -
      sudo apt-get install -y nodejs
    displayName: 'setup'  
  - script: |
      npm install check_submodules
      ./../../node_modules/.bin/check_submodules . master
    displayName: 'build'   

- phase: windowsx86
  queue:
    name: 'aziotbld-win03'
  steps:
  # - script: |
  #     call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\Common7\Tools\VsDevCmd.bat"
  #     call jenkins\windows_c.cmd
  #   displayName: 'build'
  #   env:
  #     IOTHUB_CONNECTION_STRING: $(IOTHUB-CONNECTION-STRING)
  #     IOTHUB_EVENTHUB_CONNECTION_STRING: $(IOTHUB-EVENTHUB-CONNECTION-STRING)
  #     IOTHUB_E2E_X509_CERT_BASE64: $(IOTHUB-E2E-X509-CERT-BASE64)
  #     IOTHUB_E2E_X509_PRIVATE_KEY_BASE64: $(IOTHUB-E2E-X509-PRIVATE-KEY-BASE64)
  #     IOTHUB_E2E_X509_THUMBPRINT: $(IOTHUB-E2E-X509-THUMBPRINT)
  #     IOTHUB_POLICY_KEY: $(IOTHUB-POLICY-KEY)
  #     STORAGE_ACCOUNT_CONNECTION_STRING: $(STORAGE-ACCOUNT-CONNECTION-STRING)
  #     IOT_DPS_CONNECTION_STRING: $(IOT-DPS-CONNECTION-STRING)
  #     IOT_DPS_ID_SCOPE: $(IOT-DPS-ID-SCOPE)
  #     IOTHUB_DEVICE_CONN_STRING_INVALIDCERT: $(IOTHUB-DEVICE-CONN-STRING-INVALIDCERT)
  #     IOTHUB_CONN_STRING_INVALIDCERT: $(IOTHUB-CONN-STRING-INVALIDCERT)
  #     DPS_GLOBALDEVICEENDPOINT_INVALIDCERT: $(DPS-GLOBALDEVICEENDPOINT-INVALIDCERT)
  #     # PROVISIONING_CONNECTION_STRING_INVALIDCERT: $(PROVISIONING-CONNECTION-STRING-INVALIDCERT)

  - script: |
      ls 
      call build\collect_results.cmd
    displayName: 'Collect Test Results'
    condition: succeededOrFailed()
  - task: PublishTestResults@2
    displayName: 'Publish Test_RelWithDebInfo results'
    inputs:
      testResultsFiles: '**/results-junit.xml'
      mergeTestResults: true
      testRunTitle: 'Ubuntu1604 RelWithDebInfo Tests' 
    condition: succeededOrFailed()
  - script: cd .. && rd /Q /S $(Agent.BuildDirectory)\s
    displayName: 'cleanup'
    condition: always()