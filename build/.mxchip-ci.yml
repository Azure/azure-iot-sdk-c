name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)

jobs:
- job: Cross_Compile
  pool:
    vmImage: ubuntu-16.04
  steps:
  - script: |
      . build_all/mbed5/setup.sh
    displayName: 'setup'

  - script: |
      . build_all/mbed5/build.sh
    displayName: 'build'
    env:
      SOURCE_BRANCH: '$Build.SourceBranchName'

  - script: |
      # Check that this is the right source directory
      ls
      cp mxchip/BUILD/AZ3166/GCC_ARM/mxchip.bin $(Build.ArtifactStagingDirectory)
    displayName: "Copy Files into Artifact repo"

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts: drop'
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'drop'
      publishLocation: 'Container'
    condition: succeeded()

- job: Execute
  dependsOn: Cross_Compile
  pool:
    name: $(MXCHIPAGENTPOOL)
  steps:
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Build Artifacts'
    inputs:
      artifactName: 'drop'

  - script: |
      echo $(NEWTIN) | sudo -S cp $(System.ArtifactsDirectory)/drop/mxchip.bin /media/newt/AZ31662
    displayName: 'deploy'

  - script: |
      cd $(ClientLibrary.FrameworkRoot)/testtools/UART_interface/
      . input.sh
      python3 serial_connect.py -i input.txt -o output.txt -b 115200 -p "/dev/ttyACM1"
    env:
      SERIAL_TASK: $(SERIAL_TASK)
    displayName: 'run_test'

  - script: |
      # Check that this is the right source directory
      ls
      cp output.txt $(Build.ArtifactStagingDirectory)
    displayName: "Copy Files into Artifact repo"

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts: log'
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'log'
      publishLocation: 'Container'
    condition: succeeded()
